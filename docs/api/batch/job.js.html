<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>job.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Device.html">Device</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Device.html#addTag">addTag</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Device.html#hasTags">hasTags</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Device.html#message">message</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="DevicePool.html">DevicePool</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="DevicePool.html#.instance">instance</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="DevicePool.html#free">free</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="DevicePool.html#initialize">initialize</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="DevicePool.html#lock">lock</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Evaluator.html">Evaluator</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Evaluator.html#.evaluate">evaluate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Evaluator.html#.evaluateExpectedField">evaluateExpectedField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Evaluator.html#.jsonQuery">jsonQuery</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Interceptor.html">Interceptor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Interceptor.html#.instance">instance</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Interceptor.html#interceptError">interceptError</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Interceptor.html#interceptPostProcess">interceptPostProcess</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Interceptor.html#interceptPreProcess">interceptPreProcess</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Interceptor.html#interceptRecord">interceptRecord</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Interceptor.html#interceptRequest">interceptRequest</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Interceptor.html#interceptResult">interceptResult</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Job.html">Job</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Job.html#.fromJSON">fromJSON</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Job.html#.lazyFetchJobForKey">lazyFetchJobForKey</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Job.html#addProcessedCount">addProcessedCount</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Job.html#addResult">addResult</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Job.html#expectedFieldNames">expectedFieldNames</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Job.html#logURL">logURL</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Job.html#outputFieldNames">outputFieldNames</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Job.html#toJSON">toJSON</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Metrics.html">Metrics</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Metrics.html#.instance">instance</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Metrics.html#initialize">initialize</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Metrics.html#publish">publish</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Printer.html">Printer</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Printer.html#.instance">instance</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Printer.html#print">print</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Record.html">Record</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Record.html#.fromJSON">fromJSON</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Record.html#addDeviceTag">addDeviceTag</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Record.html#addExpectedField">addExpectedField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Record.html#addOutputField">addOutputField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Record.html#addSetting">addSetting</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Record.html#outputField">outputField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Record.html#toJSON">toJSON</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Result.html">Result</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Result.html#.fromJSON">fromJSON</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Result.html#actualField">actualField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Result.html#addActualField">addActualField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Result.html#addOutputField">addOutputField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Result.html#addTag">addTag</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Result.html#outputField">outputField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Result.html#toJSON">toJSON</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Result.html#toString">toString</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Source.html">Source</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Source.html#.instance">instance</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Source.html#filter">filter</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Source.html#loadAll">loadAll</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Source.html#loadRecord">loadRecord</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">job.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const _ = require('lodash')
const Client = require('@bespoken-sdk/store/lib/client')
const fs = require('fs')
const JSONUtil = require('@bespoken-sdk/shared/lib/json-util')
const logger = require('@bespoken-sdk/shared/lib/logger')('JOB')
const moment = require('moment')
const Record = require('./record')
const Result = require('./result')

/**
 * Class that manages info and execution of a particular job
 */
class Job {
  /**
   * This routine loads a Job
   * It checks first for it locally - if it's not there, it loads it remotely
   * It then saves it locally for faster access
   * @param {string} key
   * @returns {Promise&lt;Job>}
   */
  static async lazyFetchJobForKey (key) {
    const StoreClient = require('@bespoken-sdk/store/lib/client')
    const store = new StoreClient()
    if (!fs.existsSync('data')) {
      fs.mkdirSync('data')
    }

    // If there is NOT a dash, means this key is in encrypted UUID format
    // We decrypt by calling our server
    let decryptedKey = key
    if (!key.includes('-')) {
      decryptedKey = await store.decrypt(key)
      logger.info('JOB LAZYFETCH decrypted key: ' + decryptedKey)
    }

    let dataFile = `data/${decryptedKey}`
    if (!dataFile.endsWith('.json')) {
      dataFile = `${dataFile}.json`
    }

    let jobJSON
    if (process.env.FORCE_RELOAD === undefined &amp;&amp; fs.existsSync(dataFile)) {
      jobJSON = JSON.parse(fs.readFileSync(dataFile, 'utf-8'))
    } else {
      jobJSON = await store.fetch(key)
      fs.writeFileSync(dataFile, JSON.stringify(jobJSON, null, 2))
    }

    console.info('Job JSON: ' + JSON.stringify(jobJSON, null, 2))
    
    const job = Job.fromJSON(jobJSON)
    return job
  }

  /**
   * Creates a new Job object from JSON
   * @param {Object} json
   * @returns {Job}
   */
  static fromJSON (json) {
    const job = new Job(json.name, json.run, json.config)
    JSONUtil.fromJSON(job, json)
    console.info('job.results: ' + job.results.length + ' job._results: ' + job._results.length)
    // Loop through results and turn into objects
    const resultObjects = []
    for (const resultJSON of job.results) {
      const record = Record.fromJSON(resultJSON.record)
      
      const result = Result.fromJSON(record, resultJSON)
      
      // Make the record property back into a record object - I know, we do similar stuff below :-)
      resultObjects.push(result)
    }
    job._results = resultObjects

    // Loop through the records and turn them into objects
    const records = []
    for (const record of job._records) {
      records.push(Record.fromJSON(record))
    }
    job._records = records
    return job
  }

  /**
   * @param {string} name
   * @param {string | undefined} run
   * @param {any} config
   */
  constructor (name, run, config) {
    const now = moment().utc()
    this._name = name
    if (run) {
      this._run = run
    } else {
      this._run = name + '_' + now.format('YYYY-MM-DDTHH-mm-ss')
    }
    this._timestamp = now.format()
    this._config = config
    this._key = undefined
    this._records = []
    this._results = []
    this._processedCount = 0
    this.totalCount = 0
    this._rerun = false
  }

  /**
   * @returns {any}
   */
  get config () {
    return this._config
  }

  /**
   * The date the job was created (UTC)
   * Saved in ISO 8601 format: YYYY-MM-DDThh:mm:ssZ
   * Eg. 2020-05-21T15:50:13Z
   * @type {string}
   */
  get timestamp () {
    return this._timestamp
  }

  /**
   * @returns {string}
   */
  get customer () {
    return this.config.customer
  }

  /**
   * @returns {string | undefined}
   */
  get key () {
    return this._key
  }
  
  /**
   *
   */
  set key (key) {
    this._key = key
  }

  /**
   * @returns {string}
   */
  get name () {
    return this._name
  }

  /**
   * @returns {number}
   */
  get processedCount () {
    return this._processedCount
  }

  /**
   * @returns {Record[]} The records for the job
   */
  get records () {
    return this._records
  }

  /**
   *
   */
  set records (records) {
    this._records = records
  }
  
  /**
   * @returns {boolean}
   */
   get rerun () {
    return this._rerun
  }

  /**
   * Sets the rerun flag
   */
  set rerun (rerun) {
    this._rerun = rerun
  }
  
  /**
   * @returns {Result[]} The results for the job
   */
  get results () {
    return this._results
  }

  /**
   * The run name
   * @type {string}
   */
  get run () {
    return this._run
  }
  
  /**
   *
   */
  set run (run) {
    this._run = run
  }

  /**
   * @returns {string}
   */
  get status () {
    let recordsToProcess = this.records.length
    const limit = _.get(this, 'config.limit')
    if (limit &amp;&amp; limit &lt; recordsToProcess) {
      recordsToProcess = limit
    }
    if (this.processedCount === recordsToProcess) {
      return 'COMPLETED'
    } else {
      return 'NOT_COMPLETED'
    }
  }
  
  /**
   * Captures a result of a record being processed
   * @param {Result} result
   * @returns {void}
   */
  addResult (result) {
    this._results.push(result)
  }

  /**
   * Increments the number of records being processed
   * @param {number} [count] Defaults to 1
   * @returns {void}
   */
  addProcessedCount (count = 1) {
    this._processedCount += count
  }

  /**
   * Iterates across all the results to see all the expected field values
   * @returns {string[]} Return the list of expected field names
   */
  expectedFieldNames () {
    const fields = this._uniqueFields(this._records, 'expectedFields')
    // logger.log(`JOB expectedFields: ${fields}`)
    return fields
  }

  /**
   * @param {number} index
   * @returns {string}
   */
   logURL (index) {
    if (!this.key) {
      return 'N/A'
    }

    return `https://store.bespoken.io/store/json/batch-runner/${this.key}?path=$..results[${index}].responses[-1:]`
  }

  /**
   * @returns {string[]}
   */
  outputFieldNames () {
    // Add output fields from the records as well as the results
    const fields = this._uniqueFields(this._results, 'outputFields')
    // logger.log(`JOB ouputFields: ${fields}`)
    return fields
  }

  /**
   * @returns {any}
   */
  toJSON() {
    return JSONUtil.toJSON(this)
  }

  /**
   * @private
   * @param {Object[]} recordArray
   * @param {string} resultProperty
   * @returns {string[]}
   */
  _uniqueFields (recordArray, resultProperty) {
    const fields = []
    recordArray.forEach(result => {
      // logger.log(`RESULT ${resultProperty}: ${result[resultProperty]}`)
      Object.keys(result[resultProperty]).forEach(field => {
        if (fields.indexOf(field) === -1) {
          fields.push(field)
        }
      })
    })
    return fields
  }
}

module.exports = Job
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Fri Jan 21 2022 15:06:16 GMT-0500 (Eastern Standard Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
