<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>device.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Device.html">Device</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Device.html#addTag">addTag</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Device.html#hasTags">hasTags</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Device.html#message">message</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="DevicePool.html">DevicePool</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="DevicePool.html#.instance">instance</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="DevicePool.html#free">free</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="DevicePool.html#initialize">initialize</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="DevicePool.html#lock">lock</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Evaluator.html">Evaluator</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Evaluator.html#.evaluate">evaluate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Evaluator.html#.evaluateExpectedField">evaluateExpectedField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Evaluator.html#.jsonQuery">jsonQuery</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Interceptor.html">Interceptor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Interceptor.html#.instance">instance</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Interceptor.html#interceptError">interceptError</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Interceptor.html#interceptPostProcess">interceptPostProcess</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Interceptor.html#interceptPreProcess">interceptPreProcess</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Interceptor.html#interceptRecord">interceptRecord</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Interceptor.html#interceptRequest">interceptRequest</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Interceptor.html#interceptResult">interceptResult</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Job.html">Job</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Job.html#.fromJSON">fromJSON</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Job.html#.lazyFetchJobForKey">lazyFetchJobForKey</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Job.html#addProcessedCount">addProcessedCount</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Job.html#addResult">addResult</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Job.html#expectedFieldNames">expectedFieldNames</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Job.html#logURL">logURL</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Job.html#outputFieldNames">outputFieldNames</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Job.html#toJSON">toJSON</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Metrics.html">Metrics</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Metrics.html#.instance">instance</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Metrics.html#initialize">initialize</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Metrics.html#publish">publish</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Printer.html">Printer</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Printer.html#.instance">instance</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Printer.html#print">print</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Record.html">Record</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Record.html#.fromJSON">fromJSON</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Record.html#addDeviceTag">addDeviceTag</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Record.html#addExpectedField">addExpectedField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Record.html#addOutputField">addOutputField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Record.html#addSetting">addSetting</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Record.html#outputField">outputField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Record.html#toJSON">toJSON</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Result.html">Result</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Result.html#.fromJSON">fromJSON</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Result.html#actualField">actualField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Result.html#addActualField">addActualField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Result.html#addOutputField">addOutputField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Result.html#addTag">addTag</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Result.html#outputField">outputField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Result.html#toJSON">toJSON</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Result.html#toString">toString</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Source.html">Source</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Source.html#.instance">instance</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Source.html#filter">filter</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Source.html#loadAll">loadAll</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Source.html#loadRecord">loadRecord</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">device.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const _ = require('lodash')
const Config = require('@bespoken-sdk/shared/lib/config')
const Interceptor = require('./interceptor')
const logger = require('@bespoken-sdk/shared/lib/logger')('DEVICE')
const Record = require('./record')
const util = require('./util')
const vdk = require('virtual-device-sdk')

/**
 *
 */
class Device {
  /**
   * @param {string} token
   * @param {boolean} skipSTT
   * @param {Object&lt;string, string>} settings
   * @param {any} configuration
   */
  constructor (token, skipSTT = false, settings, configuration) {
    this._token = token
    this._skipSTT = skipSTT
    this._settings = settings
    this._tags = []
    this._configuration = configuration
  }

  /**
   * @param {Record} record
   * @param {string[]} messages
   * @param {number} [attempt=1]
   * @returns {Promise&lt;any[]>}
   */
  async message (record, messages, attempt = 1) {
    logger.info('MESSAGE ' + messages.toString() + ' locale: ' + record.locale + ' voice: ' + record.voiceID)
    const voiceID = record.voiceID || Config.get('virtualDeviceConfig.voiceID', false, 'en-US-Wavenet-D')
    const locale = record.locale || Config.get('virtualDeviceConfig.locale', false, 'en-US')
    let config = {
      asyncMode: true,
      debug: true,
      locale: locale,
      skipSTT: this._skipSTT,
      token: this._token,
      voiceID: voiceID 
    }

    if (this._configuration) { config = _.assign(config, this._configuration) }

    const virtualDevice = new vdk.VirtualDevice(config)

    virtualDevice.baseURL = Config.get('virtualDeviceBaseURL', false, 'https://virtual-device.bespoken.io')

    try {
      const messagesArray = []
      messages.forEach(message => {
        const messageObject = {}
        const isRawFile = config.platform !== 'phone' &amp;&amp; message.endsWith('.raw')
        if (config.platform !== 'phone' &amp;&amp; message.startsWith('http')) {
          messageObject.audio = {
            audioURL: message,
            channels: 1,
            frameRate: 16000
          }
        } else if (isRawFile || message.startsWith('./')) {
          messageObject.audio = {
            audioPath: message,
            channels: 1,
            frameRate: 16000
          }
        } else {
          messageObject.text = message
        }

        if (this.settings) {
          messageObject.settings = this.settings
        }

        if (record.settings) {
          if (!messageObject.settings) {
            messageObject.settings = {}
          }
          Object.assign(messageObject.settings, record.settings)
        }
        messagesArray.push(messageObject)
      })

      logger.debug('MESSAGE request: ' + JSON.stringify(messagesArray))
      await Interceptor.instance().interceptRequest(record, messagesArray, this)
      const response = await virtualDevice.batchMessage(messagesArray)
      logger.debug('MESSAGE initial response: ' + JSON.stringify(response))
      if (response.conversation_id) {
        let result = { status: 'IN_PROGRESS' }
        const waitTimeInterval = _.get(this._configuration, 'waitTimeInterval') || 1000
        const maxWaitTime = _.get(this._configuration, 'maxWaitTime') || 300000
        let totalTimeWaited = 0

        record.conversationId = response.conversation_id
        // Wait 10 seconds to start
        await util.sleep(waitTimeInterval)

        while (result.status === 'IN_PROGRESS' &amp;&amp; totalTimeWaited &lt; maxWaitTime) {
          try {
            result = await virtualDevice.getConversationResults(response.conversation_id)
            logger.debug('message result: ' + JSON.stringify(result, null, 2))
            totalTimeWaited += waitTimeInterval
          } catch (e) {
            const error = this._parseError(e)
            logger.error(`ERROR GET CONVERSATION ID: ${response.conversation_id} error property: ${error}`)
            // If this is an error from the virtual device, do a retry
            if (error.error) {
              return this._retry(error, messages, record, attempt)
            }
          }
          await util.sleep(waitTimeInterval)
        }

        if (result.status === 'IN_PROGRESS') {
          // Server timed out, try again up the max attempts
          const errorMessage = `DEVICE ERROR maxWaitTime exceed: ${maxWaitTime} conversation id: ${response.conversation_id}`
          logger.error(errorMessage)
          return this._retry(errorMessage, messages, record, attempt)
        }

        logger.debug('DEVICE MESSAGE final transcript: ' + _.get(_.nth(_.get(result, 'results'), -1), 'transcript'))
        return result.results
      } else {
        return response.results
      }
    } catch (e) {
      return this._retry(this._parseError(e), messages, record, attempt)
    }
  }

  /**
   * @param {string} tag
   * @returns {void}
   */ 
  addTag (tag) {
    this._tags.push(tag)
  }
  
  /**
   * @param {string[]} tags
   * @returns {boolean}
   */
  hasTags (tags) {
    let success = true
    tags.forEach((tag) => {
      if (this._tags.indexOf(tag) === -1) {
        success = false
      }
    })
    return success
  }
  
  /**
   * Returns the name of the platform this device corresponds to
   * @type {string}
   */
  get platform () {
    let platform = 'other'
    if (this._token.startsWith('alexa')) {
      platform = 'amazon-alexa'
    } else if (this._token.startsWith('google')) {
      platform = 'google-assistant'
    } else if (this._token.startsWith('phone')) {
      platform = 'phone'
    }
    return platform
  }
  
  /**
   * @returns {Object&lt;string, any>}
   */
  get settings () {
    return this._settings
  }
  
  /**
   * @type {string[]}
   */
  get tags () {
    return this._tags
  }

  /**
   * @type {string}
   */
  get token () {
    return this._token
  }

  /**
   * @private
   * @param {any} error
   * @param {string[]} messages
   * @param {Record} record
   * @param {number} attempt
   * @returns {Promise&lt;any[]>}
   */
  async _retry (error, messages, record, attempt) {
    const errorMessage = error.error ? error.error : error.toString()
    if (attempt > Config.get('maxAttempts', true, 3)) {
      // Give up after three tries
      throw errorMessage
    }

    const backoffTime = Config.get('backoffTime', false, 10)
    logger.error(`DEVICE MESSAGE error: ${errorMessage} retrying ${backoffTime} seconds`)
    await util.sleep(backoffTime * 1000)
    return this.message(record, messages, attempt + 1)
  }

  /**
   * @private
   * @param {any} error
   * @returns {any}
   */
  _parseError (error) {
    if (_.isObject(error)) {
      return error
    } else {
      try {
        return JSON.parse(error)
      } catch (e) {
        return e
      }
    }
  }
}

/**
 *
 */
class DevicePool {
  /**
   * @returns {DevicePool}
   */
  static instance () {
    return Config.instance('device-pool', DevicePool)
  }

  /**
   *
   */
  constructor () {
    this._devices = []
    this.initialize()
  }

  /**
   * @returns {void}
   */
  initialize () {
    const tokensInfo = Config.get('virtualDevices', true)
    const virtualDeviceConfig = Config.get('virtualDeviceConfig', false)
    const tokens = Object.keys(tokensInfo)
    const maxTokens = process.env.VIRTUAL_DEVICE_LIMIT ? parseInt(process.env.VIRTUAL_DEVICE_LIMIT) : tokens.length
    this._devices = []

    let skipSTT = false
    if (Config.has('transcript')) {
      skipSTT = Config.get('transcript') === false
    }
    // Create a device for each token
    tokens.slice(0, maxTokens).forEach(token => {
      const tokenInfo = tokensInfo[token]
      let tags
      if (Array.isArray(tokenInfo)) {
        tags = tokenInfo
      } else {
        tags = tokenInfo.tags ? tokenInfo.tags : []
      }

      // Clean the tags - trim them
      tags = tags.map(tag => tag.trim())
      logger.info(`CREATE token: ${token} skipSTT: ${skipSTT} tags: ${tags} settings: ${JSON.stringify(tokenInfo.settings)}`)
      const device = new Device(token.trim(), skipSTT, tokenInfo.settings, virtualDeviceConfig)

      // Add the tags to the device
      tags.forEach(tag => device.addTag(tag))
      this._devices.push(device)
    })

    // Create an array to track the devices currently in use
    this._devicesInUse = []
  }

  /**
   * @param {Record} record
   * @returns {Promise&lt;Device>}
   */
  async lock (record) {
    // Check if there are any devices at all
    if (this._validDevices(record).length === 0) {
      logger.error(`LOCK no device exists to process tags: ${record.deviceTags}`)
      process.exit(1)
    }

    logger.debug(`LOCK tags: ${record.deviceTags} count: ${this._freeDevices(record).length}`)
    while (this._freeDevices(record).length === 0) {
      await util.sleep(1000)
    }

    // If there is a free token, add to our list of tokens in use so no one else can use it
    const device = this._freeDevices(record).find((device) => {
      return this._devicesInUse.find(d => d.token === device.token) === undefined
    })

    if (!device) {
      throw new Error('No device available for locking')
    }

    this._devicesInUse.push(device)
    logger.debug(`LOCK acquire tags: ${record.deviceTags} available: ${this._freeDevices(record).length} token: ${device.token}`)

    return device
  }

  /**
   * @param {Device} device
   * @returns {Promise&lt;void>}
   */
  async free (device) {
    // Remove the token we used from our tokens in list use - i.e., return it to the free pool
    this._devicesInUse = _.pull(this._devicesInUse, device)
    logger.debug('FREE ' + device._token + ' tokens available: ' + this._freeCount())
  }

  /**
   * @private
   * @param {Record} record
   * @returns {Device[]}
   */
  _freeDevices (record) {
    const validDevices = this._validDevices(record)

    // Then filter down to those that are available
    const freeDevices = validDevices.filter(device => {
      return !this._devicesInUse.find(d => d.token === device.token)
    })
    return freeDevices
  }

  /**
   * @private
   * @returns {number}
   */
  _freeCount () {
    return this._devices.length - this._devicesInUse.length
  }

  // Filter to the devices that have tags that match the record
  /**
   * @private
   * @param {Record} record
   * @returns {Device[]}
   */
  _validDevices (record) {
    if (!this._devices) {
      throw new Error('There are no valid devices')
    }

    const validDevices = this._devices.filter(device => {
      return device.hasTags(record.deviceTags)
    })
    return validDevices
  }
}

module.exports = {
  Device,
  DevicePool
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Fri Jan 21 2022 15:06:16 GMT-0500 (Eastern Standard Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
